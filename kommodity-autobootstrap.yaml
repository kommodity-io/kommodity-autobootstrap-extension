name: kommodity-autobootstrap
container:
  entrypoint: ./kommodity-autobootstrap-extension
  mounts:
    # System secrets to check if control plane (etcd secrets only exist on CP)
    - source: /system/secrets
      destination: /system/secrets
      type: bind
      options:
        - bind
        - ro
    # /proc for reading boot time and network routes
    # Mount to /host/proc to avoid conflicting with container's own /proc
    - source: /proc
      destination: /host/proc
      type: bind
      options:
        - bind
        - ro
    # /etc for hostname
    - source: /etc
      destination: /etc
      type: bind
      options:
        - bind
        - ro
    # /dev for accessing block devices to mount STATE partition
    # Must mount full /dev because /dev/disk/by-partlabel/STATE is a symlink to /dev/sdX
    # Use rbind to recursively bind nested mounts within /dev
    - source: /dev
      destination: /dev
      type: bind
      options:
        - rbind
        - ro
    # /run for creating temporary mount points under /run/autobootstrap
    # Used to mount STATE partition and read machine config
    # /run is a writable tmpfs in Talos Linux
    - source: /run
      destination: /run
      type: bind
      options:
        - rbind
        - rw
# configuration: true means the extension waits for ExtensionServiceConfig
# which can provide optional environment variables
configuration: true
depends:
  - service: apid
  - network:
      - addresses
      - connectivity
      - hostname
      - etcfiles
restart: untilSuccess
