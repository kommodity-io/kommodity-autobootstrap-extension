name: kommodity-autobootstrap
container:
  entrypoint: ./kommodity-autobootstrap-extension
  mounts:
    # System secrets to check if control plane (etcd secrets only exist on CP)
    - source: /system/secrets
      destination: /system/secrets
      type: bind
      options:
        - bind
        - ro
    # /proc for reading boot time and network routes
    # Mount to /host/proc to avoid conflicting with container's own /proc
    - source: /proc
      destination: /host/proc
      type: bind
      options:
        - bind
        - ro
    # /etc for hostname
    - source: /etc
      destination: /etc
      type: bind
      options:
        - bind
        - ro
    # Block devices for mounting STATE partition to read machine config
    - source: /dev/disk/by-partlabel
      destination: /dev/disk/by-partlabel
      type: bind
      options:
        - bind
        - ro
    # /var/mnt for creating temporary mount points under /var/mnt/autobootstrap
    # Used to mount STATE partition and read machine config
    - source: /var/mnt
      destination: /var/mnt
      type: bind
      options:
        - bind
        - rw
# configuration: true means the extension waits for ExtensionServiceConfig
# which can provide optional environment variables
configuration: true
depends:
  - service: apid
  - network:
      - addresses
      - connectivity
      - hostname
      - etcfiles
restart: untilSuccess
